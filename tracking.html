<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Tracking Kereta | KAI Inovasi</title>

  <!-- Gunakan style global proyek -->
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    /* Mini page-specific styling (melengkapi style.css) */
    .page-hero {
      background: linear-gradient(90deg,#004aad,#0073e6);
      color: #fff;
      padding: 28px 40px;
      text-align: center;
      border-radius: 6px;
      margin: 20px;
    }

    .tracking-wrapper {
      display:flex;
      gap:20px;
      padding: 20px;
      max-width:1200px;
      margin: 0 auto 60px;
      align-items: flex-start;
    }

    /* Map container */
    #map { height: 640px; width: 100%; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }

    /* Sidebar */
    .sidebar {
      width: 380px;
      max-width: 38%;
      min-width: 300px;
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      display:flex;
      flex-direction: column;
      gap: 14px;
    }

    .filter-row { display:flex; gap:10px; }
    .filter-row input, .filter-row select {
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid #e0e6f0;
      font-family:inherit;
    }

    .train-list {
      max-height: 420px;
      overflow:auto;
      display:flex;
      flex-direction: column;
      gap:10px;
      padding-right:6px;
    }

    .train-card {
      border-radius:10px;
      padding:12px;
      background: linear-gradient(180deg, #fff, #fbfcff);
      border: 1px solid #eef3ff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      transition: transform .15s, box-shadow .15s;
      cursor: pointer;
    }
    .train-card:hover { transform: translateY(-4px); box-shadow: 0 8px 18px rgba(0,0,0,0.06); }

    .train-meta { flex:1; }
    .train-meta h4 { margin:0; color:#004aad; font-size:16px; }
    .small { font-size:13px; color:#666; margin-top:6px; }

    .eta-badge {
      font-weight:700;
      padding:8px 10px;
      border-radius:8px;
      background: #fffae6;
      color:#b26b00;
      border: 1px solid #ffe7a6;
      font-size:13px;
      min-width:85px;
      text-align:center;
    }

    .controls { display:flex; gap:10px; align-items:center; }
    .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
    .btn.primary { background:#ff6600; color:#fff; }
    .btn.ghost { background:transparent; border:1px solid #e6eefc; color:#004aad; }

    /* Responsive */
    @media (max-width: 980px) {
      .tracking-wrapper { flex-direction:column; padding:12px; }
      .sidebar { width:100%; max-width:100%; min-width:0; order:2; }
      #map { order:1; height:520px; }
    }
  </style>
</head>
<body>
  <!-- Header / Navbar (jika perlu) -->
  <header style="background:#fff; padding:12px 24px; box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;">
      <div style="display:flex;gap:12px;align-items:center;">
        <img src="logo kai.png" alt="KAI" style="height:46px;"/>
        <div style="font-weight:700;color:#004aad;font-size:18px">KAI Inovasi</div>
      </div>
      <nav style="display:flex;gap:18px;">
        <a href="index.html">Home</a>
        <a href="jadwal.html" style="color:#004aad;font-weight:600">Jadwal</a>
        <a href="booking.html">Booking</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="page-hero">
      <h1>Tracking Kereta — Real-time </h1>
      <p style="opacity:.9; margin-top:8px;">Lacak posisi kereta, filter berdasarkan asal/tujuan, dan lihat estimasi waktu tiba (ETA).</p>
    </section>

    <div class="tracking-wrapper">
      <!-- Map -->
      <div style="flex:1;">
        <div id="map"></div>
      </div>

      <!-- Sidebar: controls + list -->
      <aside class="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong style="color:#004aad">Daftar Kereta Aktif</strong>
            <div class="small">Klik sebuah kereta untuk fokus di peta</div>
          </div>
          <div class="controls">
            <button class="btn ghost" id="btn-center">Center All</button>
            <button class="btn primary" id="btn-refresh">Refresh</button>
          </div>
        </div>

        <!-- Filters -->
        <div>
          <div class="filter-row">
            <input type="text" id="filter-asal" placeholder="Filter Asal (mis: Gambir)">
            <input type="text" id="filter-tujuan" placeholder="Filter Tujuan (mis: Bandung)">
          </div>
          <div style="margin-top:8px; display:flex;gap:8px;">
            <select id="filter-region">
              <option value="">Semua Wilayah</option>
              <option>Jabodetabek</option>
              <option>Jawa Barat</option>
              <option>Jawa Tengah</option>
              <option>Jawa Timur</option>
            </select>
            <button class="btn primary" id="btn-apply">Terapkan</button>
          </div>
        </div>

        <!-- Train list -->
        <div class="train-list" id="trainList" aria-live="polite">
          <!-- Isi oleh JS -->
        </div>

        <div style="font-size:13px;color:#666;">
          <strong>Catatan:</strong> Ini adalah simulasi posisi realtime. Untuk integrasi nyata gunakan API lokasi dari sistem operasi KAI.
        </div>
      </aside>
    </div>
  </main>

  <footer style="text-align:center;padding:18px;color:#666;border-top:1px solid #f0f4ff;">
    © 2025 KAI Inovasi — Demo Tracking
  </footer>

  <!-- Script: tracking logic -->
  <script>
    /**************************************************************************
     * Demo Real-time Tracking (Client-side simulation)
     * - Simulates several trains moving along routes (simple linear interpolation)
     * - Calculates ETA based on remaining distance and speed
     * - Provides filtering (asal/tujuan/region) and ability to focus on map
     **************************************************************************/

    // Utility: haversine distance (km)
    function haversine([lat1, lon1], [lat2, lon2]) {
      const toRad = (v) => v * Math.PI/180;
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Sample station coords (could be expanded)
    const stations = {
      "Gambir": [-6.1745, 106.8296],
      "Bandung": [-6.9147, 107.6098],
      "Surabaya": [-7.2575, 112.7521],
      "Yogyakarta": [-7.7972, 110.3688],
      "Semarang": [-6.9667, 110.4167],
      "Bekasi": [-6.2383, 106.9896],
      "Bogor": [-6.5950, 106.8166]
    };

    // Define a few simulated trains with origin/destination (and region tag)
    const trains = [
      { id: "AP-001", name:"Argo Parahyangan", origin:"Gambir", dest:"Bandung", region:"Jawa Barat", speedKmH: 80 },
      { id: "AW-101", name:"Argo Wilis", origin:"Surabaya", dest:"Yogyakarta", region:"Jawa Timur", speedKmH: 90 },
      { id: "TA-210", name:"Taksaka", origin:"Gambir", dest:"Yogyakarta", region:"Jawa Tengah", speedKmH: 85 },
      { id: "KW-070", name:"KRL Commuter", origin:"Bogor", dest:"Gambir", region:"Jabodetabek", speedKmH: 60 },
      { id: "SJ-303", name:"Siliwangi", origin:"Bandung", dest:"Surabaya", region:"Jawa Barat", speedKmH: 95 }
    ];

    // Initialize each train with a current position (start at origin) and timestamp
    trains.forEach(t => {
      t.originPos = stations[t.origin];
      t.destPos = stations[t.dest] || [t.originPos[0]+0.5, t.originPos[1]+0.5];
      t.progress = 0; // 0..1 along route
      t.lastUpdate = Date.now();
      t.marker = null;
      // compute distance
      t.totalKm = haversine(t.originPos, t.destPos);
    });

    // Initialize map
    const map = L.map('map', { zoomControl:true }).setView([-7.0, 110.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Polyline for each train route (visual)
    trains.forEach(t => {
      const poly = L.polyline([t.originPos, t.destPos], { color: '#0073e6', weight: 2, dashArray: '6 8' }).addTo(map);
      t.routeLine = poly;
      // initial marker
      const icon = L.divIcon({
        html: `<div style="background:#004aad;color:#fff;padding:6px 8px;border-radius:8px;font-weight:700;font-size:12px;">${t.id}</div>`,
        className: ''
      });
      t.marker = L.marker(t.originPos, { icon }).addTo(map).bindPopup(`<b>${t.name}</b><br>${t.origin} → ${t.dest}`);
    });

    // Fit map to show all routes initially
    const group = L.featureGroup(trains.map(t => t.routeLine));
    map.fitBounds(group.getBounds().pad(0.2));

    // Rendering train list
    const trainListEl = document.getElementById('trainList');

    function formatETA(minutes) {
      if (!isFinite(minutes)) return '—';
      if (minutes < 1) return 'Sampai sekarang';
      if (minutes < 60) return Math.round(minutes) + ' mnt';
      const hrs = Math.floor(minutes / 60);
      const mins = Math.round(minutes % 60);
      return hrs + ' j ' + (mins > 0 ? mins + ' m' : '');
    }

    function renderTrainList(filter = {}) {
      trainListEl.innerHTML = '';
      const list = trains.filter(t => {
        if (filter.region && filter.region !== '' && t.region !== filter.region) return false;
        if (filter.asal && filter.asal.trim() !== '' && !t.origin.toLowerCase().includes(filter.asal.toLowerCase())) return false;
        if (filter.tujuan && filter.tujuan.trim() !== '' && !t.dest.toLowerCase().includes(filter.tujuan.toLowerCase())) return false;
        return true;
      });

      if (list.length === 0) {
        trainListEl.innerHTML = '<div style="color:#666">Tidak ada kereta sesuai filter.</div>';
        return;
      }

      list.forEach(t => {
        // compute remaining distance based on progress
        const curLat = t.originPos[0] + (t.destPos[0]-t.originPos[0]) * t.progress;
        const curLon = t.originPos[1] + (t.destPos[1]-t.originPos[1]) * t.progress;
        const remainingKm = haversine([curLat, curLon], t.destPos);
        const etaMinutes = (remainingKm / t.speedKmH) * 60; // in minutes
        const arrivalTime = new Date(Date.now() + etaMinutes*60*1000);

        const card = document.createElement('div');
        card.className = 'train-card';
        card.innerHTML = `
          <div class="train-meta">
            <h4>${t.name} <span style="font-size:12px;color:#888;font-weight:600">(${t.id})</span></h4>
            <div class="small">${t.origin} → ${t.dest} • region ${t.region}</div>
            <div class="small">Kecepatan: ${t.speedKmH} km/h • Sisa: ${remainingKm.toFixed(1)} km</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div class="eta-badge">${formatETA(etaMinutes)}</div>
            <div style="font-size:12px;color:#888">${arrivalTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
          </div>
        `;
        card.addEventListener('click', () => {
          // focus on marker
          const curPos = [curLat, curLon];
          map.setView(curPos, 12, { animate:true });
          t.marker.openPopup();
        });
        trainListEl.appendChild(card);
      });
    }

    // Initial render
    renderTrainList({});

    // Simulation loop: update train progress every second
    function stepSimulation(deltaSec) {
      trains.forEach(t => {
        // move progress by delta: calculate distance moved = speed * time
        const kmToMove = (t.speedKmH * (deltaSec/3600)); // km
        const remainingKm = t.totalKm * (1 - t.progress);
        // convert kmToMove to progress delta
        const progressDelta = t.totalKm > 0 ? (kmToMove / t.totalKm) : 0;
        t.progress += progressDelta;
        if (t.progress > 1) t.progress = 1; // arrived

        // update marker position
        const lat = t.originPos[0] + (t.destPos[0]-t.originPos[0]) * t.progress;
        const lon = t.originPos[1] + (t.destPos[1]-t.originPos[1]) * t.progress;
        t.marker.setLatLng([lat, lon]);
        // update popup content with ETA
        const remKm = haversine([lat, lon], t.destPos);
        const etaMin = (remKm / t.speedKmH) * 60;
        t.marker.setPopupContent(`<b>${t.name}</b><br>${t.origin} → ${t.dest}<br>Sisa ${remKm.toFixed(1)} km • ETA ${formatETA(etaMin)}`);
      });
      // re-render list
      const filter = {
        region: document.getElementById('filter-region').value,
        asal: document.getElementById('filter-asal').value,
        tujuan: document.getElementById('filter-tujuan').value
      };
      renderTrainList(filter);
    }

    // Run simulation using setInterval
    let lastTick = Date.now();
    setInterval(() => {
      const now = Date.now();
      const dt = (now - lastTick) / 1000.0; // seconds
      lastTick = now;
      stepSimulation(dt);
    }, 1500); // update ~1.5s

    // Buttons / filters
    document.getElementById('btn-apply').addEventListener('click', () => {
      const filter = {
        region: document.getElementById('filter-region').value,
        asal: document.getElementById('filter-asal').value,
        tujuan: document.getElementById('filter-tujuan').value
      };
      renderTrainList(filter);
      // optionally center to first match
      const first = trains.find(t => {
        if (filter.region && filter.region !== '' && t.region !== filter.region) return false;
        if (filter.asal && filter.asal.trim() !== '' && !t.origin.toLowerCase().includes(filter.asal.toLowerCase())) return false;
        if (filter.tujuan && filter.tujuan.trim() !== '' && !t.dest.toLowerCase().includes(filter.tujuan.toLowerCase())) return false;
        return true;
      });
      if (first) {
        const lat = first.originPos[0] + (first.destPos[0]-first.originPos[0]) * first.progress;
        const lon = first.originPos[1] + (first.destPos[1]-first.originPos[1]) * first.progress;
        map.setView([lat, lon], 10, { animate:true });
      }
    });

    document.getElementById('btn-center').addEventListener('click', () => {
      map.fitBounds(group.getBounds().pad(0.2));
    });

    document.getElementById('btn-refresh').addEventListener('click', () => {
      // reset filters & re-render
      document.getElementById('filter-region').value = '';
      document.getElementById('filter-asal').value = '';
      document.getElementById('filter-tujuan').value = '';
      renderTrainList({});
      map.fitBounds(group.getBounds().pad(0.2));
    });

    // When user clicks a marker, highlight corresponding card (optional)
    trains.forEach(t => {
      t.marker.on('click', () => {
        // scroll to the card in list
        const cards = Array.from(document.querySelectorAll('.train-card'));
        const idx = trains.indexOf(t);
        if (cards[idx]) {
          cards[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
          cards[idx].style.background = 'linear-gradient(180deg,#fff8e6,#fff)';
          setTimeout(()=> cards[idx].style.background='linear-gradient(180deg,#fff,#fbfcff)',700);
        }
      });
    });

  </script>
</body>
</html>
